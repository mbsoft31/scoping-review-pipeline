{% extends "base.html" %}

{% block content %}
<div x-data="prismaApp()" class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">PRISMA Flow Diagram</h1>
        <p class="text-gray-600">
            Generate a PRISMA flow diagram summarising your systematic review process. Select the relevant directories and click generate.
        </p>
    </div>
    <div class="bg-white rounded-lg shadow p-6 mb-6 space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Phase¬†1 directory (required)</label>
            <select x-model="form.phase1_dir" class="w-full px-3 py-2 border rounded text-sm" required>
                <option value="">Select a Phase 1 directory...</option>
                {% for dir in phase1_dirs %}
                <option value="{{ dir }}">{{ dir.name }}</option>
                {% endfor %}
            </select>
            <p class="text-xs text-gray-500 mt-1">Directory containing search results (Phase¬†1).</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Screening directory (optional)</label>
            <select x-model="form.screening_dir" class="w-full px-3 py-2 border rounded text-sm">
                <option value="">None</option>
                {% for dir in phase15_dirs %}
                <option value="{{ dir }}">{{ dir.name }}</option>
                {% endfor %}
            </select>
            <p class="text-xs text-gray-500 mt-1">Directory with screening results (Phase¬†1.5).</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Deduplication directory (optional)</label>
            <select x-model="form.dedup_dir" class="w-full px-3 py-2 border rounded text-sm">
                <option value="">None</option>
                {% for dir in phase2_dirs %}
                <option value="{{ dir }}">{{ dir.name }}</option>
                {% endfor %}
            </select>
            <p class="text-xs text-gray-500 mt-1">Directory with deduplicated papers (Phase¬†2).</p>
        </div>
        <button @click="startPrisma()" :disabled="loading || !form.phase1_dir" class="w-full bg-pink-600 hover:bg-pink-700 disabled:bg-gray-400 text-white font-bold py-3 rounded-lg">
            <span x-show="!loading">üìä Generate PRISMA Diagram</span>
            <span x-show="loading">‚è≥ Generating...</span>
        </button>
    </div>
    <!-- Progress and results -->
    <div x-show="jobId" class="mt-6 p-6 bg-pink-50 rounded-lg" x-cloak>
        <h3 class="text-lg font-semibold text-gray-800 mb-3">PRISMA Progress</h3>
        <div hx-get="/api/jobs/:jobId/progress" hx-trigger="every 2s" hx-swap="innerHTML" :hx-get="`/api/jobs/${jobId}/progress`">
            Loading progress...
        </div>
        <div x-show="diagramReady && !loading" class="mt-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Diagram</h4>
            <img :src="`/api/prisma/${jobId}/image`" alt="PRISMA diagram" class="w-full max-w-3xl border rounded shadow mb-4">
            <div x-show="counts">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">Counts</h4>
                <ul class="list-disc list-inside text-gray-700 text-sm">
                    <li>Records identified: <span x-text="counts.records_identified"></span></li>
                    <li>Duplicates removed: <span x-text="counts.duplicates_removed"></span></li>
                    <li>Records screened: <span x-text="counts.records_screened"></span></li>
                    <li>Records excluded: <span x-text="counts.records_excluded"></span></li>
                    <li>Full‚Äëtext articles assessed: <span x-text="counts.reports_assessed"></span></li>
                    <li>Full‚Äëtext articles excluded: <span x-text="counts.reports_excluded"></span></li>
                    <li>Studies included: <span x-text="counts.studies_included"></span></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function prismaApp() {
    return {
        form: {
            phase1_dir: '',
            screening_dir: '',
            dedup_dir: '',
        },
        loading: false,
        jobId: null,
        diagramReady: false,
        counts: null,
        async startPrisma() {
            this.loading = true;
            this.diagramReady = false;
            try {
                const payload = {
                    phase1_dir: this.form.phase1_dir,
                    screening_dir: this.form.screening_dir || null,
                    dedup_dir: this.form.dedup_dir || null,
                };
                const resp = await fetch('/api/prisma/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await resp.json();
                this.jobId = data.job_id;
                this.pollProgress();
                if (window.htmx) {
                    window.htmx.process(document.body);
                }
            } catch (err) {
                alert('PRISMA generation failed: ' + err.message);
            } finally {
                this.loading = false;
            }
        },
        pollProgress() {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/jobs/${this.jobId}`);
                    const job = await res.json();
                    if (job.status === 'completed') {
                        clearInterval(interval);
                        this.diagramReady = true;
                        this.counts = job.counts || null;
                    } else if (job.status === 'failed') {
                        clearInterval(interval);
                        alert('PRISMA generation failed: ' + job.error);
                    }
                } catch (err) {
                    console.error('Error polling PRISMA job:', err);
                }
            }, 2000);
        },
    };
}
</script>
{% endblock %}