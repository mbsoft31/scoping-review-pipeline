{% extends "base.html" %}

{% block content %}
<div x-data="metaApp()" class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Metaâ€‘Analysis</h1>
        <p class="text-gray-600">
            Perform a statistical metaâ€‘analysis by uploading a CSV file of effect estimates and standard errors.
        </p>
    </div>
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Upload Effect Size Data</h3>
        <form @submit.prevent="startMeta" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">CSV file (.csv)</label>
                <input type="file" @change="handleFile" accept=".csv" class="w-full px-4 py-2 border rounded-lg text-sm" required>
                <p class="text-xs text-gray-500 mt-1">The file must contain columns for study identifiers, effect estimates and standard errors.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Study ID column</label>
                    <input type="text" x-model="form.study_col" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="study_id">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Effect column</label>
                    <input type="text" x-model="form.effect_col" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="effect">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Standard error column</label>
                    <input type="text" x-model="form.se_col" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="se">
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Pooling method</label>
                <select x-model="form.method" class="w-full px-3 py-2 border rounded-lg text-sm">
                    <option value="random">Random effects</option>
                    <option value="fixed">Fixed effect</option>
                </select>
            </div>
            <button type="submit" :disabled="loading || !file" class="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white font-bold py-3 px-4 rounded-lg">
                <span x-show="!loading">ğŸ§® Run Metaâ€‘Analysis</span>
                <span x-show="loading">â³ Processing...</span>
            </button>
        </form>
    </div>
    <!-- Progress and results -->
    <div x-show="jobId" class="mt-6 p-6 bg-teal-50 rounded-lg" x-cloak>
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Metaâ€‘Analysis Progress</h3>
        <div hx-get="/api/jobs/:jobId/progress" hx-trigger="every 2s" hx-swap="innerHTML" :hx-get="`/api/jobs/${jobId}/progress`">
            Loading progress...
        </div>
        <div x-show="result && !loading" class="mt-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Results</h4>
            <p class="text-gray-700 text-sm mb-2"><strong>Pooled effect:</strong> <span x-text="result.pooled.pooled_effect.toFixed(4)"></span> Â± <span x-text="result.pooled.standard_error.toFixed(4)"></span></p>
            <p class="text-gray-700 text-sm mb-2"><strong>Heterogeneity (IÂ²):</strong> <span x-text="result.heterogeneity.I_squared.toFixed(1)"></span>% (<span x-text="result.heterogeneity.interpretation"></span>)</p>
            <p class="text-gray-700 text-sm mb-2"><strong>Publication bias:</strong> <span x-text="result.bias.interpretation"></span></p>
            <div class="mt-4">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">Forest Plot</h4>
                <img :src="`/api/meta/${jobId}/plot`" alt="Forest plot" class="w-full max-w-3xl border rounded shadow" x-show="!loading">
            </div>
        </div>
    </div>
</div>

{# Component logic moved to a TypeScript module loaded via Vite. #}
{% endblock %}