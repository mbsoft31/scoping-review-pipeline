{% extends "base.html" %}

{% block title %}Analyze - Systematic Review Pipeline{% endblock %}

{% block content %}
<div x-data="analyzeApp()" class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Phase 2: Citation Analysis</h1>
        <p class="text-gray-600 mb-8">Run deduplication, citation enrichment and influence scoring on Phase¬†1 results.</p>
        <!-- Phase 1 directory selection -->
        <form @submit.prevent="submitAnalysis" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Phase 1 directory</label>
                <select x-model="form.phase1_dir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select a Phase 1 directory...</option>
                    {% for dir in phase1_dirs %}
                    <option value="{{ dir }}">{{ dir.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max papers for citations</label>
                    <input type="number" x-model.number="form.citation_max_papers" min="1" max="1000" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Top N papers (by citation count) to fetch citations for.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">References per paper</label>
                    <input type="number" x-model.number="form.refs_per_paper" min="1" max="500" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Maximum references to fetch for each paper.</p>
                </div>
            </div>
            <!-- Advanced options toggle -->
            <div x-data="{showAdvanced: false}">
                <button type="button" @click="showAdvanced = !showAdvanced" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                    <span x-show="!showAdvanced">‚ñ∂ Show advanced options</span>
                    <span x-show="showAdvanced">‚ñº Hide advanced options</span>
                </button>
                <div x-show="showAdvanced" x-cloak class="mt-4 space-y-4 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fuzzy match threshold</label>
                        <input type="number" x-model.number="form.fuzzy_threshold" min="0.5" max="1" step="0.05" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Title similarity threshold for deduplication (0.5‚Äì1.0).</p>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" x-model="form.skip_citations" class="text-blue-600">
                            <span class="text-sm text-gray-700">Skip citation fetching (deduplication only)</span>
                        </label>
                    </div>
                </div>
            </div>
            <button type="submit" :disabled="loading || !form.phase1_dir" class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold py-3 px-4 rounded-lg transition">
                <span x-show="!loading">üß¨ Start Analysis</span>
                <span x-show="loading">‚è≥ Starting...</span>
            </button>
        </form>
        <!-- Progress section -->
        <div x-show="jobId" class="mt-8 p-6 bg-green-50 rounded-lg" x-cloak>
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Analysis Progress</h3>
            <div hx-get="/api/jobs/:jobId/progress" hx-trigger="every 2s" hx-swap="innerHTML" :hx-get="`/api/jobs/${jobId}/progress`">
                Loading progress...
            </div>
            <div x-show="currentPhase" class="mt-4 space-y-2">
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full" :class="currentPhase === 'loading' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'">
                        <span x-show="currentPhase === 'loading'">1</span>
                        <span x-show="currentPhase !== 'loading'">‚úì</span>
                    </div>
                    <span class="text-sm text-gray-700">Loading papers</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full" :class="currentPhase === 'deduplicating' ? 'bg-blue-100 text-blue-600' : (phaseComplete('deduplicating') ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400')">
                        <span x-show="currentPhase !== 'deduplicating' && !phaseComplete('deduplicating')">2</span>
                        <span x-show="currentPhase === 'deduplicating'">‚è≥</span>
                        <span x-show="phaseComplete('deduplicating')">‚úì</span>
                    </div>
                    <span class="text-sm text-gray-700">Deduplicating papers</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full" :class="currentPhase === 'fetching_citations' ? 'bg-blue-100 text-blue-600' : (phaseComplete('fetching_citations') ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400')">
                        <span x-show="currentPhase !== 'fetching_citations' && !phaseComplete('fetching_citations')">3</span>
                        <span x-show="currentPhase === 'fetching_citations'">‚è≥</span>
                        <span x-show="phaseComplete('fetching_citations')">‚úì</span>
                    </div>
                    <span class="text-sm text-gray-700">Fetching citations</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full" :class="currentPhase === 'computing_influence' ? 'bg-blue-100 text-blue-600' : (phaseComplete('computing_influence') ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400')">
                        <span x-show="currentPhase !== 'computing_influence' && !phaseComplete('computing_influence')">4</span>
                        <span x-show="currentPhase === 'computing_influence'">‚è≥</span>
                        <span x-show="phaseComplete('computing_influence')">‚úì</span>
                    </div>
                    <span class="text-sm text-gray-700">Computing influence scores</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}